generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

// ============================================
// ENUMERATIONS
// ============================================

enum Role {
  ADMIN
  STAFF
  STUDENT
  PARENT
}

enum EntityType {
  STUDENT
  PARENT
  STAFF
  COURSE
  DEPARTMENT
  BUILDING
  ROOM
  EVENT
  ANNOUNCEMENT
  ASSESSMENT
  ASSIGNMENT
  COURSE_CONTENT
}

enum AttributeDataType {
  STRING
  NUMBER
  BOOLEAN
  DATE
  DATETIME
  TEXT
  EMAIL
  PHONE
  URL
  JSON
}

enum AttributeCategory {
  PERSONAL
  ACADEMIC
  CONTACT
  EMPLOYMENT
  FACILITY
  SCHEDULE
  FINANCIAL
  SYSTEM
  CONTENT
}

enum TaskType {
  GRADING
  MEETING
  PREPARATION
  ADMIN
}

enum TaskPriority {
  HIGH
  MEDIUM
  LOW
}

enum GradeType {
  ASSIGNMENT
  QUIZ
  MIDTERM
  FINAL
  PROJECT
}

enum MaterialType {
  LECTURE
  READING
  VIDEO
  RESOURCE
}

enum SubmissionStatus {
  SUBMITTED
  PENDING
  LATE
  NOT_SUBMITTED
}

// ============================================
// AUTHENTICATION & AUTHORIZATION
// ============================================

model Account {
  id                String    @id @default(cuid())
  email             String    @unique
  password          String
  role              Role
  isActive          Boolean   @default(true)
  mustChangePassword Boolean  @default(false)
  tempPassword      String?   // Stores the plain text temp password for admin viewing
  lastLogin         DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Link to Entity for extended profile data (EAV pattern)
  entityId          String?   @unique
  entity            Entity?   @relation(fields: [entityId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([role])
  @@map("accounts")
}

// ============================================
// EAV (Entity-Attribute-Value) PATTERN
// ============================================

model Entity {
  id          String     @id @default(cuid())
  type        EntityType
  name        String?
  code        String?
  description String?    @db.Text
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  values        Value[]
  account       Account?
  
  parentId      String?
  parent        Entity?   @relation("EntityHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children      Entity[]  @relation("EntityHierarchy")

  relationsFrom EntityRelation[] @relation("FromEntity")
  relationsTo   EntityRelation[] @relation("ToEntity")

  @@index([type])
  @@index([code])
  @@index([parentId])
  @@index([isActive])
  @@map("entities")
}

model Attribute {
  id           String            @id @default(cuid())
  name         String            @unique
  displayName  String
  description  String?           @db.Text
  dataType     AttributeDataType
  category     AttributeCategory
  isRequired   Boolean           @default(false)
  isUnique     Boolean           @default(false)
  isSearchable Boolean           @default(true)
  
  entityTypes     String         @db.Text
  validationRules String?        @db.Text
  options         String?        @db.Text
  
  defaultValue String?
  displayOrder Int               @default(0)
  
  isActive     Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  values       Value[]

  @@index([category])
  @@index([dataType])
  @@index([isActive])
  @@map("attributes")
}

model Value {
  id           String    @id @default(cuid())
  entityId     String
  attributeId  String

  valueString   String?   @db.VarChar(500)
  valueNumber   Float?
  valueBool     Boolean?
  valueDate     DateTime? @db.Date
  valueDateTime DateTime?
  valueText     String?   @db.Text
  valueJson     String?   @db.Text

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  entity       Entity    @relation(fields: [entityId], references: [id], onDelete: Cascade)
  attribute    Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([entityId, attributeId])
  @@index([entityId])
  @@index([attributeId])
  @@map("values")
}

// ============================================
// ENTITY RELATIONSHIPS (Many-to-Many with metadata)
// ============================================

model EntityRelation {
  id            String    @id @default(cuid())
  fromEntityId  String
  toEntityId    String
  relationType  String    // e.g., "ENROLLED_IN", "TEACHES", "BELONGS_TO", "LOCATED_IN"
  
  // Metadata about the relationship
  metadata      String?   @db.Text // JSON field for additional data
  
  isActive      Boolean   @default(true)
  startDate     DateTime?
  endDate       DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  fromEntity    Entity    @relation("FromEntity", fields: [fromEntityId], references: [id], onDelete: Cascade)
  toEntity      Entity    @relation("ToEntity", fields: [toEntityId], references: [id], onDelete: Cascade)

  @@unique([fromEntityId, toEntityId, relationType])
  @@index([fromEntityId])
  @@index([toEntityId])
  @@index([relationType])
  @@map("entity_relations")
}

// ============================================
// STAFF COURSE MANAGEMENT
// ============================================

model Course {
  id            String   @id @default(cuid())
  code          String   @unique
  name          String
  description   String?  @db.Text
  schedule      String   // e.g., "Mon/Wed 10:00 AM"
  room          String   // e.g., "Lab 102"
  
  staffId       String
  staff         Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  students      CourseEnrollment[]
  grades        StudentGrade[]
  materials     CourseMaterial[]
  assignments   CourseAssignment[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([staffId])
  @@index([code])
  @@map("courses")
}

model CourseEnrollment {
  id          String   @id @default(cuid())
  courseId    String
  studentId   String
  
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  enrolledAt  DateTime @default(now())
  grade       String?  // Final grade (A, B, C, etc.)

  @@unique([courseId, studentId])
  @@index([courseId])
  @@index([studentId])
  @@map("course_enrollments")
}

model Staff {
  id              String   @id @default(cuid())
  accountId       String   @unique
  firstName       String
  lastName        String
  email           String   @unique
  phone           String?
  department      String?
  qualifications  String?  @db.Text
  bio             String?  @db.Text
  
  courses         Course[]
  tasks           StaffTask[]
  messages        Message[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([email])
  @@index([department])
  @@map("staff")
}

model Student {
  id              String   @id @default(cuid())
  accountId       String   @unique
  firstName       String
  lastName        String
  email           String   @unique
  phone           String?
  parentEmail     String?
  
  enrollments     CourseEnrollment[]
  grades          StudentGrade[]
  submissions     CourseSubmission[]
  attendance      Attendance[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([email])
  @@map("students")
}

// ============================================
// GRADING SYSTEM
// ============================================

model StudentGrade {
  id            String   @id @default(cuid())
  courseId      String
  studentId     String
  gradeType     GradeType
  title         String   // e.g., "Assignment 1", "Midterm"
  score         Float?
  maxScore      Float    @default(100)
  percentage    Float?   // Calculated percentage
  letter        String?  // Letter grade (A, B, C, etc.)
  feedback      String?  @db.Text
  
  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  gradedAt      DateTime?
  dueDate       DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([courseId, studentId, gradeType, title])
  @@index([courseId])
  @@index([studentId])
  @@map("student_grades")
}

// ============================================
// COURSE MATERIALS & ASSIGNMENTS
// ============================================

model CourseMaterial {
  id            String   @id @default(cuid())
  courseId      String
  title         String
  description   String?  @db.Text
  type          MaterialType
  fileUrl       String?
  fileSize      String?  // e.g., "45 MB"
  
  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  uploadedAt    DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([courseId])
  @@map("course_materials")
}

model CourseAssignment {
  id            String   @id @default(cuid())
  courseId      String
  title         String
  description   String?  @db.Text
  dueDate       DateTime
  maxScore      Float    @default(100)
  
  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  submissions   CourseSubmission[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([courseId])
  @@map("course_assignments")
}

model CourseSubmission {
  id            String   @id @default(cuid())
  assignmentId  String
  studentId     String
  status        SubmissionStatus
  submittedFile String?
  submittedAt   DateTime?
  
  assignment    CourseAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student       Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
  @@map("course_submissions")
}

// ============================================
// STAFF TASKS
// ============================================

model StaffTask {
  id            String   @id @default(cuid())
  staffId       String
  title         String
  description   String?  @db.Text
  type          TaskType
  priority      TaskPriority
  dueDate       DateTime
  isCompleted   Boolean  @default(false)
  completedAt   DateTime?
  
  staff         Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([staffId])
  @@index([priority])
  @@index([dueDate])
  @@map("staff_tasks")
}

// ============================================
// ATTENDANCE & CLASS MANAGEMENT
// ============================================

model Attendance {
  id            String   @id @default(cuid())
  studentId     String
  courseId      String?
  date          DateTime
  status        String   // "PRESENT", "ABSENT", "LATE"
  notes         String?  @db.Text
  
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())

  @@unique([studentId, date])
  @@index([studentId])
  @@index([date])
  @@map("attendance")
}

// ============================================
// MESSAGING
// ============================================

model Message {
  id            String   @id @default(cuid())
  staffId       String
  recipientId   String?  // Student or Parent ID
  subject       String
  body          String   @db.Text
  isRead        Boolean  @default(false)
  
  staff         Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  sentAt        DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([staffId])
  @@index([recipientId])
  @@index([isRead])
  @@map("messages")
}

// ============================================
// REAL-TIME CHAT
// ============================================

model Conversation {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  participants  ConversationParticipant[]
  messages      ChatMessage[]
  
  @@map("conversations")
}

model ConversationParticipant {
  id              String       @id @default(cuid())
  conversationId  String
  accountId       String
  joinedAt        DateTime     @default(now())
  lastReadAt      DateTime?
  
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@unique([conversationId, accountId])
  @@index([accountId])
  @@map("conversation_participants")
}

model ChatMessage {
  id              String       @id @default(cuid())
  conversationId  String
  senderId        String       // accountId
  content         String       @db.Text
  createdAt       DateTime     @default(now())
  
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@index([senderId])
  @@map("chat_messages")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id          String   @id @default(cuid())
  accountId   String
  type        String   // "message", "assignment", "grade", "announcement"
  title       String
  body        String   @db.Text
  link        String?
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  @@index([accountId])
  @@index([isRead])
  @@map("notifications")
}
